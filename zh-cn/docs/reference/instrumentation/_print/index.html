<!doctype html><html lang=zh-cn class=no-js><head><meta name=robots content="noindex, nofollow"><link rel=alternate hreflang=en href=https://kubernetes.io/docs/reference/instrumentation/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.102.3"><link rel=canonical type=text/html href=https://kubernetes.io/zh-cn/docs/reference/instrumentation/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>插桩 | Kubernetes</title><meta property="og:title" content="插桩"><meta property="og:description" content="生产级别的容器编排系统"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/zh-cn/docs/reference/instrumentation/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="插桩"><meta itemprop=description content="生产级别的容器编排系统"><meta name=twitter:card content="summary"><meta name=twitter:title content="插桩"><meta name=twitter:description content="生产级别的容器编排系统"><link href=/scss/main.css rel=stylesheet><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://kubernetes.io/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content><meta property="og:description" content><meta name=twitter:description content><meta property="og:url" content="https://kubernetes.io/zh-cn/docs/reference/instrumentation/"><meta property="og:title" content="插桩"><meta name=twitter:title content="插桩"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/jquery-3.6.0.min.js intregrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary><a class="navbar-brand img-fluid" href=/zh-cn/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/zh-cn/docs/>文档</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/blog/>Kubernetes 博客</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/training/>培训</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/partners/>合作伙伴</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/community/>社区</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/case-studies/>案例分析</a></li><li class="nav-item mr-n3 mr-lg-0 dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>版本列表</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh-cn/releases>发布信息</a>
<a class=dropdown-item href=https://kubernetes.io/zh-cn/docs/reference/instrumentation/>v1.26</a>
<a class=dropdown-item href=https://v1-25.docs.kubernetes.io/zh-cn/docs/reference/instrumentation/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/zh-cn/docs/reference/instrumentation/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/zh-cn/docs/reference/instrumentation/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/zh-cn/docs/reference/instrumentation/>v1.22</a></div></li><li class="nav-item mr-n4 mr-lg-0 dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 (Chinese)</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/reference/instrumentation/>English</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/zh-cn/docs/reference/instrumentation/>返回本页常规视图</a>.</p></div><h1 class=title>插桩</h1><ul><li>1: <a href=#pg-d5514661bd5474ed823c8310529da4f4>Kubernetes 组件 SLI 指标</a></li><li>2: <a href=#pg-f80c94e2a1fba0c24275841ffe8ec997>节点指标数据</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-d5514661bd5474ed823c8310529da4f4>1 - Kubernetes 组件 SLI 指标</h1><div style=margin-top:10px;margin-bottom:10px><b>特性状态：</b> <code>Kubernetes v1.26 [alpha]</code></div><p>作为一个 Alpha 特性，Kubernetes 允许你为每个 Kubernetes 组件二进制文件配置服务水平指示器 (SLI) 指标。
此指标端点被暴露在每个组件提供 HTTPS 服务的端口上，路径为 <code>/metrics/slis</code>。
你必须为想要抓取 SLI 指标的每个组件启用 <code>ComponentSLIs</code>
<a href=/zh-cn/docs/reference/command-line-tools-reference/feature-gates/>特性门控</a>。</p><h2 id=sli-metrics>SLI 指标</h2><p>启用 SLI 指标时，每个 Kubernetes 组件暴露两个指标，按照健康检查添加标签：</p><ul><li>计量值（表示健康检查的当前状态）</li><li>计数值（记录观察到的每个健康检查状态的累计次数）</li></ul><p>你可以使用此指标信息计算每个组件的可用性统计信息。例如，API 服务器检查 etcd 的健康。
你可以计算并报告 etcd 的可用或不可用情况，具体由其客户端（即 API 服务器）进行报告。</p><p>Prometheus 计量表数据看起来类似于：</p><pre tabindex=0><code># HELP kubernetes_healthcheck [ALPHA] This metric records the result of a single healthcheck.
# TYPE kubernetes_healthcheck gauge
kubernetes_healthcheck{name=&#34;autoregister-completion&#34;,type=&#34;healthz&#34;} 1
kubernetes_healthcheck{name=&#34;autoregister-completion&#34;,type=&#34;readyz&#34;} 1
kubernetes_healthcheck{name=&#34;etcd&#34;,type=&#34;healthz&#34;} 1
kubernetes_healthcheck{name=&#34;etcd&#34;,type=&#34;readyz&#34;} 1
kubernetes_healthcheck{name=&#34;etcd-readiness&#34;,type=&#34;readyz&#34;} 1
kubernetes_healthcheck{name=&#34;informer-sync&#34;,type=&#34;readyz&#34;} 1
kubernetes_healthcheck{name=&#34;log&#34;,type=&#34;healthz&#34;} 1
kubernetes_healthcheck{name=&#34;log&#34;,type=&#34;readyz&#34;} 1
kubernetes_healthcheck{name=&#34;ping&#34;,type=&#34;healthz&#34;} 1
kubernetes_healthcheck{name=&#34;ping&#34;,type=&#34;readyz&#34;} 1
</code></pre><p>而计数器数据看起来类似于：</p><pre tabindex=0><code># HELP kubernetes_healthchecks_total [ALPHA] This metric records the results of all healthcheck.
# TYPE kubernetes_healthchecks_total counter
kubernetes_healthchecks_total{name=&#34;autoregister-completion&#34;,status=&#34;error&#34;,type=&#34;readyz&#34;} 1
kubernetes_healthchecks_total{name=&#34;autoregister-completion&#34;,status=&#34;success&#34;,type=&#34;healthz&#34;} 15
kubernetes_healthchecks_total{name=&#34;autoregister-completion&#34;,status=&#34;success&#34;,type=&#34;readyz&#34;} 14
kubernetes_healthchecks_total{name=&#34;etcd&#34;,status=&#34;success&#34;,type=&#34;healthz&#34;} 15
kubernetes_healthchecks_total{name=&#34;etcd&#34;,status=&#34;success&#34;,type=&#34;readyz&#34;} 15
kubernetes_healthchecks_total{name=&#34;etcd-readiness&#34;,status=&#34;success&#34;,type=&#34;readyz&#34;} 15
kubernetes_healthchecks_total{name=&#34;informer-sync&#34;,status=&#34;error&#34;,type=&#34;readyz&#34;} 1
kubernetes_healthchecks_total{name=&#34;informer-sync&#34;,status=&#34;success&#34;,type=&#34;readyz&#34;} 14
kubernetes_healthchecks_total{name=&#34;log&#34;,status=&#34;success&#34;,type=&#34;healthz&#34;} 15
kubernetes_healthchecks_total{name=&#34;log&#34;,status=&#34;success&#34;,type=&#34;readyz&#34;} 15
kubernetes_healthchecks_total{name=&#34;ping&#34;,status=&#34;success&#34;,type=&#34;healthz&#34;} 15
kubernetes_healthchecks_total{name=&#34;ping&#34;,status=&#34;success&#34;,type=&#34;readyz&#34;} 15
</code></pre><h2 id=using-this-data>使用此类数据</h2><p>组件 SLI 指标端点旨在以高频率被抓取。
高频率抓取意味着你最终会获得更细粒度的计量信号，然后可以将其用于计算 SLO。
<code>/metrics/slis</code> 端点为各个 Kubernetes 组件提供了计算可用性 SLO 所需的原始数据。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f80c94e2a1fba0c24275841ffe8ec997>2 - 节点指标数据</h1><div class=lead>访问 kubelet 所观测到的节点、卷、Pod 和容器级别指标的机制。</div><p><a href=/zh-cn/docs/reference/command-line-tools-reference/kubelet/>kubelet</a>
在节点、卷、Pod 和容器级别收集统计信息，并在
<a href=https://github.com/kubernetes/kubernetes/blob/7d309e0104fedb57280b261e5677d919cb2a0e2d/staging/src/k8s.io/kubelet/pkg/apis/stats/v1alpha1/types.go>概要 API</a>
中输出这些信息。</p><p>你可以通过 Kubernetes API 服务器将代理的请求发送到 stats 概要 API。</p><p>下面是一个名为 <code>minikube</code> 的节点的概要 API 请求示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get --raw <span style=color:#b44>&#34;/api/v1/nodes/minikube/proxy/stats/summary&#34;</span>
</span></span></code></pre></div><p>下面是使用 <code>curl</code> 所执行的相同 API 调用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># 你需要先运行 &#34;kubectl proxy&#34;</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 更改 8080 为 &#34;kubectl proxy&#34; 指派的端口</span>
</span></span><span style=display:flex><span>curl http://localhost:8080/api/v1/nodes/minikube/proxy/stats/summary
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p>从 <code>metrics-server</code> 0.6.x 开始，<code>metrics-server</code> 查询 <code>/metrics/resource</code> kubelet 端点，
不查询 <code>/stats/summary</code>。</div><h2 id=summary-api-source>概要指标 API 源</h2><p>默认情况下，Kubernetes 使用 kubelet 内运行的嵌入式 <a href=https://github.com/google/cadvisor>cAdvisor</a>
获取节点概要指标数据。</p><h2 id=pod-and-container-stats-from-cri>通过 CRI 获得概要 API 数据</h2><div style=margin-top:10px;margin-bottom:10px><b>特性状态：</b> <code>Kubernetes v1.23 [alpha]</code></div><p>如果你在自己的集群中启用 <code>PodAndContainerStatsFromCRI</code>
<a href=/zh-cn/docs/reference/command-line-tools-reference/feature-gates/>特性门控</a>，
且你通过<a class=glossary-tooltip title='一组与 kubelet 集成的容器运行时 API' data-toggle=tooltip data-placement=top href=/zh-cn/docs/concepts/overview/components/#container-runtime target=_blank aria-label=容器运行时接口>容器运行时接口</a> (CRI) 使用支持统计访问的容器运行时，
则 kubelet 将使用 CRI 而不是 cAdvisor 来获取 Pod 和容器级别的指标数据。</p><h2 id=接下来>接下来</h2><p><a href=/zh-cn/docs/tasks/debug/debug-cluster/>集群故障排查</a>任务页面讨论了如何使用依赖这些数据的指标管道。</p></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/zh-cn/docs/home/>主页</a>
<a class=text-white href=/zh-cn/blog/>博客</a>
<a class=text-white href=/zh-cn/training/>培训</a>
<a class=text-white href=/zh-cn/partners/>合作伙伴</a>
<a class=text-white href=/zh-cn/community/>社区</a>
<a class=text-white href=/zh-cn/case-studies/>案例分析</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes 作者 | 文档发布基于 <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a> 授权许可</small><br><small class=text-white>Copyright &copy; 2023 Linux 基金会&reg;。保留所有权利。Linux 基金会已注册并使用商标。如需了解 Linux 基金会的商标列表，请访问<a href=https://www.linuxfoundation.org/trademark-usage class=light-text>商标使用页面</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=/js/popper-1.16.1.min.js intregrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap-4.6.1.min.js integrity=sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2 crossorigin=anonymous></script>
<script src=/js/script.js></script>
<script async src=/js/mermaid-8.13.4.min.js integrity=sha384-5hHNvPeMrNH14oM3IcQofDoBhiclNK3g2+hnEinKzQ07C4AliMeVpnvxuiwEGpaO crossorigin=anonymous></script>
<script src=/js/main.min.5c0bf7f21dc4f66485f74efbbeeff28a7e4f8cddaac1bae47043159c922ff3a3.js integrity="sha256-XAv38h3E9mSF9077vu/yin5PjN2qwbrkcEMVnJIv86M=" crossorigin=anonymous></script></body></html>